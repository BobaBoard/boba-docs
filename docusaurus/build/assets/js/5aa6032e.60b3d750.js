"use strict";(self.webpackChunkbobadocs=self.webpackChunkbobadocs||[]).push([[9270],{5318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(7378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),d=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=d(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=d(n),h=i,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||a;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var d=2;d<a;d++)o[d]=n[d];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7485:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var r=n(5773),i=(n(7378),n(5318));const a={},o="Internal User Id",s={unversionedId:"engineering/WIPs/internal-uid",id:"engineering/WIPs/internal-uid",title:"Internal User Id",description:"Problem",source:"@site/docs/engineering/WIPs/internal-uid.md",sourceDirName:"engineering/WIPs",slug:"/engineering/WIPs/internal-uid",permalink:"/docs/engineering/WIPs/internal-uid",draft:!1,editUrl:"https://github.com/essential-randomness/bobadocs/edit/main/docs/engineering/WIPs/internal-uid.md",tags:[],version:"current",frontMatter:{},sidebar:"engineering",previous:{title:"Boards UUIDs",permalink:"/docs/engineering/WIPs/boards-uuid"},next:{title:"Visit History",permalink:"/docs/engineering/WIPs/visit-history"}},l={},d=[{value:"Problem",id:"problem",level:2},{value:"How authentication is enforced now",id:"how-authentication-is-enforced-now",level:2},{value:"Solution",id:"solution",level:2},{value:"Security considerations",id:"security-considerations",level:3}],c={toc:d};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"internal-user-id"},"Internal User Id"),(0,i.kt)("h2",{id:"problem"},"Problem"),(0,i.kt)("p",null,"Most Boba DB queries start by fetching the internal user id (the foreign key for other tables) given the external firebase id obtained during the authentication process. This makes queries cumbersome and repetitive, and unnecessarily couples a large part of the server code with the authentication mechanism used."),(0,i.kt)("h2",{id:"how-authentication-is-enforced-now"},"How authentication is enforced now"),(0,i.kt)("p",null,"Currently, authentication mechanisms are defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"handlers/auth.ts"),", which exports two relevant ",(0,i.kt)("a",{parentName:"p",href:"https://expressjs.com/en/guide/using-middleware.html"},"Express middlewares"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"isLoggedIn"),": checks whether the user is authenticated, and populates the ",(0,i.kt)("inlineCode",{parentName:"li"},"currentUser")," field (of type ",(0,i.kt)("inlineCode",{parentName:"li"},"firebase.auth.DecodedIdToken"),") in the request for following middlewares to use."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ensureLoggedIn"),": bails out of further processing for logged out users and automatically responds with ",(0,i.kt)("inlineCode",{parentName:"li"},"401")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"403")," responses as needed. This relies on ",(0,i.kt)("inlineCode",{parentName:"li"},"isLoggedIn")," to check whether the user is authenticated.")),(0,i.kt)("p",null,"Routes that call these two middlewares can then access ",(0,i.kt)("inlineCode",{parentName:"p"},"currentUser?.uid")," to retrieve the firebase id and pass it along the queries to the database."),(0,i.kt)("p",null,"Example route:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'router.get("/@me", ensureLoggedIn, async (req, res) => {\n  const currentUserId: string = req.currentUser?.uid;\n  const userData = await getUserFromFirebaseId({\n      firebaseId: currentUserId,\n    });\n  // Rest of the code\n}\n')),(0,i.kt)("p",null,"Example query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"WITH\n  logged_in_user AS\n    (SELECT id FROM users WHERE users.firebase_id = ${firebase_id})\n-- Bunch of stuff\nSELECT *\nFROM boards\nLEFT JOIN logged_in_user ON 1 = 1\n-- Bunch of stuff\n")),(0,i.kt)("h2",{id:"solution"},"Solution"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Query the DB for the internal user id in the ",(0,i.kt)("inlineCode",{parentName:"li"},"isLoggedIn")," method of ",(0,i.kt)("inlineCode",{parentName:"li"},"handlers/auth.ts")," after authentication is confirmed. The ",(0,i.kt)("inlineCode",{parentName:"li"},"getUserFromFirebaseId")," method will work nicely for this."),(0,i.kt)("li",{parentName:"ol"},"Surface it through ",(0,i.kt)("inlineCode",{parentName:"li"},"req.currentUser.internalId"),"."),(0,i.kt)("li",{parentName:"ol"},"Store the ",(0,i.kt)("inlineCode",{parentName:"li"},"firebaseId")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"userId")," mapping in the Redis cache for quick access."),(0,i.kt)("li",{parentName:"ol"},"Slowly migrate queries to directly use the internal user id.")),(0,i.kt)("h3",{id:"security-considerations"},"Security considerations"),(0,i.kt)("p",null,"The mapping from ",(0,i.kt)("inlineCode",{parentName:"p"},"firebaseId")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"userId")," never changes. As long as we ensure to rely on the cached data only after authentication is confirmed, the change has no impact"),(0,i.kt)("p",null,"At this point in time, deactivating accounts is handled by revoking firebase access privileges and isn't reflected in the internal database. If this changes, we'll need to ensure that administrative actions correctly update any relevant cached detail, especially within ",(0,i.kt)("inlineCode",{parentName:"p"},"ensureLoggedIn"),"."))}u.isMDXComponent=!0}}]);